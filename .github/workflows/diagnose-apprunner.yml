# Diagnose App Runner Service
# Manual workflow to check App Runner service status and logs

name: Diagnose App Runner

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to diagnose'
        required: true
        type: choice
        options:
          - dev
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1

jobs:
  diagnose:
    name: Diagnose App Runner - ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Service Status
        run: |
          SERVICE_NAME="automl-lite-${{ github.event.inputs.environment }}-frontend"
          
          echo "### ðŸ” App Runner Service Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get service details
          SERVICE_INFO=$(aws apprunner list-services --region ${{ env.AWS_REGION }} \
            --query "ServiceSummaryList[?ServiceName=='$SERVICE_NAME']" \
            --output json)
          
          if [ "$(echo $SERVICE_INFO | jq '. | length')" -eq 0 ]; then
            echo "âŒ Service not found: $SERVICE_NAME"
            echo "**Status:** âŒ Service not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          SERVICE_ARN=$(echo $SERVICE_INFO | jq -r '.[0].ServiceArn')
          
          # Get detailed service info
          SERVICE_DETAILS=$(aws apprunner describe-service \
            --service-arn $SERVICE_ARN \
            --region ${{ env.AWS_REGION }} \
            --output json)
          
          STATUS=$(echo $SERVICE_DETAILS | jq -r '.Service.Status')
          SERVICE_URL=$(echo $SERVICE_DETAILS | jq -r '.Service.ServiceUrl')
          IMAGE=$(echo $SERVICE_DETAILS | jq -r '.Service.SourceConfiguration.ImageRepository.ImageIdentifier')
          CREATED=$(echo $SERVICE_DETAILS | jq -r '.Service.CreatedAt')
          UPDATED=$(echo $SERVICE_DETAILS | jq -r '.Service.UpdatedAt')
          
          echo "**Status:** $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://$SERVICE_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** $IMAGE" >> $GITHUB_STEP_SUMMARY
          echo "**Created:** $CREATED" >> $GITHUB_STEP_SUMMARY
          echo "**Updated:** $UPDATED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if it's using placeholder image
          if echo "$IMAGE" | grep -q "nginx:alpine"; then
            echo "âš ï¸ **WARNING:** Service is using placeholder nginx image!"
            echo "âš ï¸ **WARNING:** Service is using placeholder nginx image!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Run 'Deploy Frontend' workflow" >> $GITHUB_STEP_SUMMARY
            echo "2. This will push the real Next.js image and trigger deployment" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Test HTTP endpoint
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ HTTP Test" >> $GITHUB_STEP_SUMMARY
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://$SERVICE_URL || echo "000")
          echo "**HTTP Response:** $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Service not responding correctly (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Service is responding (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Get Recent Operations
        run: |
          SERVICE_NAME="automl-lite-${{ github.event.inputs.environment }}-frontend"
          SERVICE_ARN=$(aws apprunner list-services --region ${{ env.AWS_REGION }} \
            --query "ServiceSummaryList[?ServiceName=='$SERVICE_NAME'].ServiceArn" \
            --output text)
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Recent Operations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List operations (last 10)
          aws apprunner list-operations \
            --service-arn $SERVICE_ARN \
            --region ${{ env.AWS_REGION }} \
            --max-results 10 \
            --query 'OperationSummaryList[*].{Type:Type,Status:Status,StartedAt:StartedAt,EndedAt:EndedAt,Updated:UpdatedAt}' \
            --output table | tee -a $GITHUB_STEP_SUMMARY
