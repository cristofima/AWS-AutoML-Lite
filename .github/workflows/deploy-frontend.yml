# Deploy Frontend (Next.js Static to S3 + CloudFront)
# Triggers on frontend changes or manual dispatch
# Automatically gets API URL from Terraform outputs

name: Deploy Frontend

on:
  push:
    branches: [dev, main]
    paths:
      - 'frontend/**'
      - '!frontend/README.md'
      - '!frontend/.gitignore'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options: [dev, prod]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.9.8

jobs:
  build-and-deploy:
    name: Deploy Frontend to ${{ github.ref == 'refs/heads/main' && 'PROD' || github.event.inputs.environment || 'DEV' }}
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || '' }}
    
    env:
      ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'prod' || github.event.inputs.environment || 'dev' }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Check Infrastructure Exists
        id: check
        run: |
          cd infrastructure/terraform
          terraform init
          
          # Try to select workspace
          if ! terraform workspace select ${{ env.ENVIRONMENT }} 2>/dev/null; then
            echo "‚ùå Workspace '${{ env.ENVIRONMENT }}' does not exist"
            echo "infrastructure_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if outputs exist
          if ! terraform output api_gateway_url 2>/dev/null; then
            echo "‚ùå Infrastructure not deployed yet"
            echo "infrastructure_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "‚úÖ Infrastructure exists"
          echo "infrastructure_exists=true" >> $GITHUB_OUTPUT

      - name: Stop if Infrastructure Missing
        if: steps.check.outputs.infrastructure_exists == 'false'
        run: |
          echo "::error::Infrastructure must be deployed first!"
          echo "::error::Run 'Deploy Infrastructure' workflow for ${{ env.ENVIRONMENT }} environment"
          echo ""
          echo "### ‚ùå Frontend Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** Infrastructure not deployed" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to Actions ‚Üí Deploy Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "2. Run workflow for **${{ env.ENVIRONMENT }}** environment" >> $GITHUB_STEP_SUMMARY
          echo "3. Wait for infrastructure deployment to complete" >> $GITHUB_STEP_SUMMARY
          echo "4. Re-run this frontend deployment" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Get Infrastructure Outputs
        id: infra
        run: |
          cd infrastructure/terraform
          terraform workspace select ${{ env.ENVIRONMENT }}
          
          API_URL=$(terraform output -raw api_gateway_url)
          BUCKET=$(terraform output -raw frontend_bucket_name 2>/dev/null || echo "")
          DISTRIBUTION_ID=$(terraform output -raw cloudfront_distribution_id 2>/dev/null || echo "")
          
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "bucket=$BUCKET" >> $GITHUB_OUTPUT
          echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
          
          echo "**API URL:** $API_URL" >> $GITHUB_STEP_SUMMARY

      - name: Check Frontend Resources
        id: check_frontend
        run: |
          if [ -z "${{ steps.infra.outputs.bucket }}" ]; then
            echo "frontend_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Frontend resources (S3/CloudFront) not deployed yet" >> $GITHUB_STEP_SUMMARY
          else
            echo "frontend_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Frontend resources exist" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Build Frontend
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.infra.outputs.api_url }}
        run: |
          echo "Building with API URL: $NEXT_PUBLIC_API_URL"
          pnpm build
          
          # Verify build output
          if [ ! -d "out" ]; then
            echo "‚ùå Build failed - 'out' directory not created"
            exit 1
          fi
          
          echo "‚úÖ Build successful"
          ls -la out/
          du -sh out/

      - name: Deploy to S3
        if: steps.check_frontend.outputs.frontend_exists == 'true'
        working-directory: frontend
        run: |
          BUCKET="${{ steps.infra.outputs.bucket }}"
          
          echo "Deploying to S3 bucket: $BUCKET"
          
          # Upload all files except HTML with long cache
          aws s3 sync out/ s3://$BUCKET \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "*.html" \
            --region ${{ env.AWS_REGION }}
          
          # Upload HTML files with short cache (for client-side routing)
          aws s3 sync out/ s3://$BUCKET \
            --exclude "*" \
            --include "*.html" \
            --cache-control "public,max-age=0,must-revalidate" \
            --region ${{ env.AWS_REGION }}
          
          echo "‚úÖ Files uploaded to S3"

      - name: Invalidate CloudFront Cache
        if: steps.check_frontend.outputs.frontend_exists == 'true' && steps.infra.outputs.distribution_id != ''
        run: |
          DISTRIBUTION_ID="${{ steps.infra.outputs.distribution_id }}"
          
          echo "Invalidating CloudFront distribution: $DISTRIBUTION_ID"
          
          aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*" \
            --region ${{ env.AWS_REGION }}
          
          echo "‚úÖ CloudFront cache invalidated"

      - name: Get Frontend URL
        if: steps.check_frontend.outputs.frontend_exists == 'true'
        id: frontend_url
        run: |
          cd infrastructure/terraform
          terraform workspace select ${{ env.ENVIRONMENT }}
          
          FRONTEND_URL=$(terraform output -raw frontend_url 2>/dev/null || echo "")
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          echo "### üöÄ Frontend Deployed - ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_frontend.outputs.frontend_exists }}" == "true" ]; then
            echo "**Status:** ‚úÖ Deployed" >> $GITHUB_STEP_SUMMARY
            echo "**Frontend URL:** ${{ steps.frontend_url.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
            echo "**API URL:** ${{ steps.infra.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
            echo "**S3 Bucket:** ${{ steps.infra.outputs.bucket }}" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "${{ steps.infra.outputs.distribution_id }}" ]; then
              echo "**CloudFront:** ${{ steps.infra.outputs.distribution_id }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Status:** ‚ö†Ô∏è Built but not deployed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Frontend resources (S3/CloudFront) not found in infrastructure." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Add frontend Terraform resources to infrastructure" >> $GITHUB_STEP_SUMMARY
            echo "2. Run 'Deploy Infrastructure' workflow" >> $GITHUB_STEP_SUMMARY
            echo "3. Re-run this frontend deployment" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Test Frontend
        if: steps.check_frontend.outputs.frontend_exists == 'true' && steps.frontend_url.outputs.frontend_url != ''
        run: |
          FRONTEND_URL="${{ steps.frontend_url.outputs.frontend_url }}"
          
          echo "Testing frontend at: $FRONTEND_URL"
          
          # Wait for CloudFront propagation
          sleep 10
          
          # Test homepage
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $FRONTEND_URL)
          
          if [ "$HTTP_CODE" == "200" ]; then
            echo "‚úÖ Frontend is accessible (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Frontend returned HTTP $HTTP_CODE (may need time for CloudFront propagation)"
          fi
