# Deploy Frontend (Next.js on AWS App Runner)
# Triggers on frontend changes or manual dispatch
# Automatically gets API URL from Terraform outputs

name: Deploy Frontend

on:
  push:
    branches: [dev, main]
    paths:
      - 'frontend/**'
      - '!frontend/README.md'
      - '!frontend/.gitignore'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options: [dev, prod]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.9.8

jobs:
  build-and-deploy:
    name: Deploy Frontend to ${{ github.ref == 'refs/heads/main' && 'PROD' || github.event.inputs.environment || 'DEV' }}
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || '' }}
    
    env:
      ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'prod' || github.event.inputs.environment || 'dev' }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Check Infrastructure Exists
        id: check
        run: |
          cd infrastructure/terraform
          terraform init
          
          # Try to select workspace
          if ! terraform workspace select ${{ env.ENVIRONMENT }} 2>/dev/null; then
            echo "‚ùå Workspace '${{ env.ENVIRONMENT }}' does not exist"
            echo "infrastructure_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if outputs exist
          if ! terraform output api_gateway_url 2>/dev/null; then
            echo "‚ùå Infrastructure not deployed yet"
            echo "infrastructure_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "‚úÖ Infrastructure exists"
          echo "infrastructure_exists=true" >> $GITHUB_OUTPUT

      - name: Stop if Infrastructure Missing
        if: steps.check.outputs.infrastructure_exists == 'false'
        run: |
          echo "::error::Infrastructure must be deployed first!"
          echo "::error::Run 'Deploy Infrastructure' workflow for ${{ env.ENVIRONMENT }} environment"
          echo ""
          echo "### ‚ùå Frontend Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** Infrastructure not deployed" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to Actions ‚Üí Deploy Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "2. Run workflow for **${{ env.ENVIRONMENT }}** environment" >> $GITHUB_STEP_SUMMARY
          echo "3. Wait for infrastructure deployment to complete" >> $GITHUB_STEP_SUMMARY
          echo "4. Re-run this frontend deployment" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Get Infrastructure Outputs
        id: infra
        run: |
          cd infrastructure/terraform
          terraform workspace select ${{ env.ENVIRONMENT }}
          
          API_URL=$(terraform output -raw api_gateway_url)
          ECR_REPO=$(terraform output -raw frontend_ecr_repository_url 2>/dev/null || echo "")
          APPRUNNER_ARN=$(terraform output -raw apprunner_service_arn 2>/dev/null || echo "")
          
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "ecr_repo=$ECR_REPO" >> $GITHUB_OUTPUT
          echo "apprunner_arn=$APPRUNNER_ARN" >> $GITHUB_OUTPUT
          
          echo "**API URL:** $API_URL" >> $GITHUB_STEP_SUMMARY
          echo "**ECR Repository:** $ECR_REPO" >> $GITHUB_STEP_SUMMARY

      - name: Check Frontend Resources
        id: check_frontend
        run: |
          if [ -z "${{ steps.infra.outputs.ecr_repo }}" ]; then
            echo "frontend_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Frontend resources (ECR/App Runner) not deployed yet" >> $GITHUB_STEP_SUMMARY
          else
            echo "frontend_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Frontend resources exist" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Login to Amazon ECR
        if: steps.check_frontend.outputs.frontend_exists == 'true'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Docker Image
        if: steps.check_frontend.outputs.frontend_exists == 'true'
        working-directory: frontend
        env:
          ECR_REPO: ${{ steps.infra.outputs.ecr_repo }}
          API_URL: ${{ steps.infra.outputs.api_url }}
          IMAGE_TAG: ${{ env.ENVIRONMENT }}-${{ github.sha }}
        run: |
          echo "Building Docker image with API URL: $API_URL"
          
          # Build with API URL baked in
          docker build \
            --build-arg NEXT_PUBLIC_API_URL=$API_URL \
            -t $ECR_REPO:$IMAGE_TAG \
            -t $ECR_REPO:${{ env.ENVIRONMENT }}-latest \
            .
          
          # Push both tags
          docker push $ECR_REPO:$IMAGE_TAG
          docker push $ECR_REPO:${{ env.ENVIRONMENT }}-latest
          
          echo "‚úÖ Image pushed: $ECR_REPO:$IMAGE_TAG"
          echo "‚úÖ Image pushed: $ECR_REPO:${{ env.ENVIRONMENT }}-latest"
          
          echo "**Docker Image:** $ECR_REPO:$IMAGE_TAG" >> $GITHUB_STEP_SUMMARY

      - name: Deploy to App Runner
        if: steps.check_frontend.outputs.frontend_exists == 'true'
        run: |
          APPRUNNER_ARN="${{ steps.infra.outputs.apprunner_arn }}"
          
          echo "Checking App Runner service status..."
          
          # Check if service is ready
          SERVICE_STATUS=$(aws apprunner describe-service \
            --service-arn $APPRUNNER_ARN \
            --region ${{ env.AWS_REGION }} \
            --query 'Service.Status' \
            --output text)
          
          echo "Current status: $SERVICE_STATUS"
          
          # Only trigger deployment if service is operational
          # (First deployment happens automatically when service is created by Terraform)
          if [ "$SERVICE_STATUS" = "RUNNING" ] || [ "$SERVICE_STATUS" = "OPERATION_IN_PROGRESS" ]; then
            echo "Triggering App Runner deployment: $APPRUNNER_ARN"
            
            aws apprunner start-deployment \
              --service-arn $APPRUNNER_ARN \
              --region ${{ env.AWS_REGION }} || true
            
            echo "‚úÖ App Runner deployment triggered"
            
            # Wait for deployment to complete
            echo "Waiting for deployment to complete (this may take 5-10 minutes)..."
            aws apprunner wait service-updated \
              --service-arn $APPRUNNER_ARN \
              --region ${{ env.AWS_REGION }} \
              --cli-read-timeout 900 \
              --cli-connect-timeout 60 || echo "‚ö†Ô∏è Timeout waiting for service, check AWS console"
            
            echo "‚úÖ Deployment completed"
          else
            echo "‚ö†Ô∏è Service is in '$SERVICE_STATUS' state, skipping deployment trigger"
            echo "First deployment will happen automatically when Terraform creates the service"
          fi

      - name: Get Frontend URL
        if: steps.check_frontend.outputs.frontend_exists == 'true'
        id: frontend_url
        run: |
          cd infrastructure/terraform
          terraform workspace select ${{ env.ENVIRONMENT }}
          
          FRONTEND_URL=$(terraform output -raw frontend_url 2>/dev/null || echo "")
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          echo "### üöÄ Frontend Deployed - ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_frontend.outputs.frontend_exists }}" == "true" ]; then
            echo "**Status:** ‚úÖ Deployed" >> $GITHUB_STEP_SUMMARY
            echo "**Frontend URL:** ${{ steps.frontend_url.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
            echo "**API URL:** ${{ steps.infra.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
            echo "**Platform:** AWS App Runner" >> $GITHUB_STEP_SUMMARY
            echo "**Container:** ${{ steps.infra.outputs.ecr_repo }}:${{ env.ENVIRONMENT }}-latest" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ‚ö†Ô∏è Built but not deployed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Frontend resources (ECR/App Runner) not found in infrastructure." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Add frontend Terraform resources to infrastructure" >> $GITHUB_STEP_SUMMARY
            echo "2. Run 'Deploy Infrastructure' workflow" >> $GITHUB_STEP_SUMMARY
            echo "3. Re-run this frontend deployment" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Test Frontend
        if: steps.check_frontend.outputs.frontend_exists == 'true' && steps.frontend_url.outputs.frontend_url != ''
        run: |
          FRONTEND_URL="${{ steps.frontend_url.outputs.frontend_url }}"
          
          echo "Testing frontend at: $FRONTEND_URL"
          
          # Wait for App Runner to be fully ready
          echo "Waiting for App Runner to propagate deployment..."
          sleep 30
          
          # Test homepage with retry logic
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $FRONTEND_URL || echo "000")
            
            if [ "$HTTP_CODE" == "200" ]; then
              echo "‚úÖ Frontend is accessible (HTTP $HTTP_CODE)"
              exit 0
            else
              echo "‚ö†Ô∏è Frontend returned HTTP $HTTP_CODE"
              if [ $i -lt $MAX_RETRIES ]; then
                echo "Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
              fi
            fi
          done
          
          echo "‚ö†Ô∏è Frontend not yet accessible after $MAX_RETRIES attempts"
          echo "This is normal for App Runner deployments - service may take 5-10 minutes to be fully ready"
          echo "Check URL manually: $FRONTEND_URL"
          exit 0  # Don't fail the workflow
